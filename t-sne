# å¯¼å…¥å¿…è¦çš„åº“
import pandas as pd                    # ç”¨äºè¯»å–å’Œå¤„ç† Excel æ•°æ®
import numpy as np                     # æä¾›æ•°å€¼è®¡ç®—æ”¯æŒ
from sklearn.manifold import TSNE      # t-SNE é™ç»´ç®—æ³•
import matplotlib.pyplot as plt        # ç»˜å›¾åŸºç¡€åº“
import seaborn as sns                  # ç¾è§‚ç»˜å›¾å°è£…
import os                              # æ“ä½œç³»ç»Ÿæ¥å£ï¼Œç”¨äºæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨

# ================== å‚æ•°è®¾ç½® ==================
input_file = '/dat05/users/dinghao/vae_latent_2500ge2.xlsx'  # è¾“å…¥çš„Excelæ–‡ä»¶è·¯å¾„
sheet_name = 'Sheet1'                 # è¦è¯»å–çš„å·¥ä½œè¡¨åç§°
id_column_index = 0                   # ç¬¬ä¸€åˆ—æ˜¯è¡Œåï¼ˆå¦‚ Latent_Dim_1ï¼‰ï¼Œä¸å‚ä¸è®¡ç®—
n_components = 2                      # t-SNE è¾“å‡ºç»´åº¦ï¼ˆ2D å¯è§†åŒ–ï¼‰
perplexity = 30                       # å›°æƒ‘åº¦ï¼šæ§åˆ¶å±€éƒ¨ä¸å…¨å±€ç»“æ„å¹³è¡¡ï¼Œä¸€èˆ¬åœ¨ 5~50 ä¹‹é—´
learning_rate = 200                   # å­¦ä¹ ç‡ï¼Œé€šå¸¸ 100~1000ï¼Œå¤ªå°æ”¶æ•›æ…¢ï¼Œå¤ªå¤§ä¸ç¨³å®š
n_iter = 1000                         # æœ€å¤§è¿­ä»£æ¬¡æ•°ï¼Œå»ºè®® â‰¥1000 æ‰èƒ½æ”¶æ•›
random_state = 42                     # éšæœºç§å­ï¼Œä¿è¯ç»“æœå¯å¤ç°
figsize = (10, 8)                     # å›¾åƒå¤§å°


# ================== æ­¥éª¤1ï¼šæ£€æŸ¥å¹¶è¯»å–æ•°æ® ==================
# æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
if not os.path.exists(input_file):
    raise FileNotFoundError(f"âŒ æ‰¾ä¸åˆ°æ–‡ä»¶: {input_file}")

# ä½¿ç”¨ pandas è¯»å–æŒ‡å®šå·¥ä½œè¡¨
df = pd.read_excel(input_file, sheet_name=sheet_name)

# æ˜¾ç¤ºå‰å‡ è¡Œæ•°æ®ï¼Œå¸®åŠ©ç¡®è®¤æ ¼å¼
print("âœ… æˆåŠŸè¯»å–åŸå§‹æ•°æ®ï¼Œå‰5è¡Œé¢„è§ˆï¼š")
print(df.head())

# ================== æ­¥éª¤2ï¼šæ•°æ®é¢„å¤„ç†ï¼ˆè®¾ç½®ç´¢å¼• + æ•°å€¼åŒ– + è½¬ç½®ï¼‰==================
# å°†ç¬¬ä¸€åˆ—è®¾ä¸ºè¡Œç´¢å¼•ï¼ˆä¾‹å¦‚ Latent_Dim_1, Latent_Dim_2...ï¼‰
df = df.set_index(df.columns[id_column_index])

# å°†æ‰€æœ‰æ•°æ®è½¬æ¢ä¸ºæ•°å€¼ç±»å‹ï¼Œæ— æ³•è½¬æ¢çš„å˜ä¸º NaN
df_numeric = df.apply(pd.to_numeric, errors='coerce')

# è½¬ç½®æ•°æ®ï¼šåŸæ¥æ˜¯ã€è¡Œä¸ºç‰¹å¾ï¼Œåˆ—ä¸ºæ ·æœ¬ã€‘â†’ ç°åœ¨å˜æˆã€è¡Œä¸ºæ ·æœ¬ï¼Œåˆ—ä¸ºç‰¹å¾ã€‘
data_transposed = df_numeric.T

# æ£€æŸ¥è½¬ç½®åæ˜¯å¦æœ‰æœ‰æ•ˆæ•°æ®
if data_transposed.empty or data_transposed.isna().all().all():
    raise ValueError("âŒ è½¬ç½®åæ— æœ‰æ•ˆæ•°å€¼æ•°æ®ï¼Œè¯·æ£€æŸ¥è¡¨æ ¼å†…å®¹æ˜¯å¦æ­£ç¡®ã€‚")

# åˆ é™¤å…¨ä¸ºç©ºçš„åˆ—ï¼ˆå¦‚æœæœ‰ï¼‰
feature_data = data_transposed.dropna(axis=1, how='all')

# å¡«å……å‰©ä½™ç¼ºå¤±å€¼ï¼ˆt-SNE ä¸æ¥å— NaNï¼‰
feature_data = feature_data.fillna(feature_data.mean())  # ç”¨å‡å€¼å¡«å……

print(f"âœ… è½¬ç½®åæ•°æ®å½¢çŠ¶: {feature_data.shape} â†’ ï¼ˆ{feature_data.shape[0]} ä¸ªæ ·æœ¬, {feature_data.shape[1]} ä¸ªç‰¹å¾ï¼‰")

# æ ·æœ¬æ ‡ç­¾ï¼šä½¿ç”¨åŸå§‹åˆ—åï¼ˆå¦‚ -1, 1, 3...ï¼‰ä½œä¸ºæ¯ä¸ªç‚¹çš„æ ‡è¯†
labels = feature_data.index.astype(str)  # è·å–æ ·æœ¬åï¼ˆå³åŸåˆ—åï¼‰

# ================== æ­¥éª¤3ï¼šæ‰§è¡Œ t-SNE é™ç»´ ==================
print("ğŸš€ æ­£åœ¨è¿›è¡Œ t-SNE é™ç»´...")
tsne = TSNE(
    n_components=n_components,          # è¾“å‡ºäºŒç»´åæ ‡
    perplexity=perplexity,             # å›°æƒ‘åº¦ï¼Œå½±å“å±€éƒ¨ä¸å…¨å±€ç»“æ„å¹³è¡¡
    learning_rate=learning_rate,       # å­¦ä¹ ç‡
    max_iter=n_iter,                   # âœ… æ”¹è¿™é‡Œï¼åŸæ¥æ˜¯ n_iterï¼Œç°åœ¨å¿…é¡»ç”¨ max_iter
    random_state=random_state,         # å›ºå®šéšæœºç§å­ä»¥å¤ç°å®éªŒ
    verbose=1                          # æ˜¾ç¤ºä¼˜åŒ–è¿‡ç¨‹è¿›åº¦ï¼ˆå¯é€‰ï¼‰
)
embedding = tsne.fit_transform(feature_data)  # å¼€å§‹é™ç»´è¿ç®—


# å°†ç»“æœä¿å­˜åˆ° DataFrameï¼Œä¾¿äºåç»­ç»˜å›¾
tsne_df = pd.DataFrame({
    'tSNE1': embedding[:, 0],           # ç¬¬ä¸€ç»´
    'tSNE2': embedding[:, 1],           # ç¬¬äºŒç»´
    'Sample': labels                    # æ ·æœ¬æ ‡ç­¾ï¼ˆå¦‚ -1, 1, 3...ï¼‰
})

# ================== æ­¥éª¤4ï¼šç»˜åˆ¶ t-SNE ç»“æœå›¾ ==================
print("ğŸ“ˆ æ­£åœ¨ç»˜åˆ¶ t-SNE å¯è§†åŒ–ç»“æœ...")

# è®¾ç½®ç¾è§‚çš„ä¸»é¢˜é£æ ¼
sns.set(style="whitegrid", font_scale=1.2)

# åˆ›å»ºç”»å¸ƒ
plt.figure(figsize=figsize)

# è‡ªåŠ¨é€‰æ‹©é…è‰²æ–¹æ¡ˆï¼šå¦‚æœæ ·æœ¬ç§ç±»å°‘ç”¨åˆ†ç±»è‰²ï¼Œå¤šåˆ™ç”¨å…‰è°±è‰²
palette = "tab10" if tsne_df['Sample'].nunique() <= 10 else "Spectral"

# ç»˜åˆ¶æ•£ç‚¹å›¾
ax = sns.scatterplot(
    x='tSNE1', y='tSNE2',               # x å’Œ y æ˜¯ t-SNE çš„ä¸¤ä¸ªç»´åº¦
    hue='Sample',                       # ä¸åŒæ ·æœ¬ç”¨ä¸åŒé¢œè‰²ï¼ˆè‹¥å¤ªå¤šä¼šæ¸å˜ï¼‰
    data=tsne_df,
    palette=palette,
    s=120,                              # ç‚¹çš„å¤§å°
    alpha=0.85,                         # é€æ˜åº¦
    edgecolor='k',                      # è¾¹æ¡†é¢œè‰²
    linewidth=0.4                       # è¾¹æ¡†å®½åº¦
)

# æ·»åŠ å›¾è¡¨æ ‡é¢˜å’Œåæ ‡è½´æ ‡ç­¾
plt.title('t-SNE Visualization of 213 Samples\n(Each Point = One Sample)', fontsize=16, pad=20)
plt.xlabel('t-SNE 1', fontsize=12)
plt.ylabel('t-SNE 2', fontsize=12)

# å°†å›¾ä¾‹ç§»åˆ°å³ä¾§å¤–éƒ¨ï¼Œé¿å…é®æŒ¡æ•°æ®
ax.legend(title='Sample ID', bbox_to_anchor=(1.05, 1), loc='upper left')

# è‡ªåŠ¨è°ƒæ•´å¸ƒå±€ï¼Œé˜²æ­¢è¢«è£å‰ª
plt.tight_layout()

# æ˜¾ç¤ºå›¾åƒï¼ˆç¨‹åºæš‚åœç›´åˆ°å…³é—­çª—å£ï¼‰
plt.show()


